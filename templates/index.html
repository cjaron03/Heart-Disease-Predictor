<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heart Health Assessment</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=6">
</head>
<body>
    <div class="app-bar">
        <div class="app-bar-content">
            <span class="material-icons logo-icon">favorite</span>
            <h1>Heart Health Assessment</h1>
        </div>
    </div>

    <div class="main-container">
        <div class="card input-card">
            <div class="card-header">
                <h2>Enter Health Metrics</h2>
                <p class="subtitle">Complete the form below to assess cardiovascular risk factors.</p>
            </div>

            <form id="risk-form">
                <div class="form-grid">
                    <!-- Age -->
                    <div class="form-group" style="animation-delay: 0.05s">
                        <label for="age">Age</label>
                        <input type="number" id="age" name="age" min="20" max="100" value="50" required>
                        <span class="hint">Your age in years</span>
                    </div>

                    <!-- Sex -->
                    <div class="form-group" style="animation-delay: 0.1s">
                        <label for="sex">Biological Sex</label>
                        <select id="sex" name="sex" required>
                            <option value="1">Male</option>
                            <option value="0">Female</option>
                        </select>
                        <span class="hint">Select biological sex</span>
                    </div>

                    <!-- Chest Pain Type -->
                    <div class="form-group" style="animation-delay: 0.15s">
                        <div class="label-row">
                            <label for="cp">Chest Pain Type</label>
                            <span class="material-icons help-icon">help_outline</span>
                            <div class="tooltip-content">Typical Angina: Chest pain related to heart.
Atypical Angina: Chest pain not related to heart.
Non-anginal Pain: Pain not caused by heart disease.
Asymptomatic: No pain.

Note: In the dataset this model was trained on, "Asymptomatic" chest pain is often associated with higher risk due to "silent ischemia," while "Typical Angina" surprisingly showed lower correlation with confirmed disease.</div>
                        </div>
                        <select id="cp" name="cp" required>
                            <option value="1">Typical Angina</option>
                            <option value="2">Atypical Angina</option>
                            <option value="3">Non-anginal Pain</option>
                            <option value="4" selected>Asymptomatic (No Pain)</option>
                        </select>
                        <span class="hint">Type of chest discomfort experienced</span>
                    </div>

                    <!-- Resting Blood Pressure -->
                    <div class="form-group" style="animation-delay: 0.2s">
                        <div class="label-row">
                            <label for="trestbps">Resting Blood Pressure</label>
                            <span class="material-icons help-icon">help_outline</span>
                            <div class="tooltip-content">The top number (systolic) of your blood pressure reading.</div>
                        </div>
                        <input type="number" id="trestbps" name="trestbps" min="80" max="220" value="130" required>
                        <span class="hint">Systolic mm Hg (Normal: 90-120)</span>
                    </div>

                    <!-- Cholesterol -->
                    <div class="form-group" style="animation-delay: 0.25s">
                        <div class="label-row">
                            <label for="chol">Serum Cholesterol</label>
                            <span class="material-icons help-icon">help_outline</span>
                            <div class="tooltip-content">Your total cholesterol level in mg/dl.</div>
                        </div>
                        <input type="number" id="chol" name="chol" min="100" max="600" value="250" required>
                        <span class="hint">Total cholesterol in mg/dl</span>
                    </div>

                    <!-- Maximum Heart Rate -->
                    <div class="form-group" style="animation-delay: 0.3s">
                        <label for="thalach">Max Heart Rate Achieved</label>
                        <input type="number" id="thalach" name="thalach" min="60" max="220" value="150" required>
                        <span class="hint">Highest heart rate during exercise</span>
                    </div>

                    <!-- Exercise Induced Angina -->
                    <div class="form-group" style="animation-delay: 0.35s">
                        <div class="label-row">
                            <label for="exang">Exercise Angina</label>
                            <span class="material-icons help-icon">help_outline</span>
                            <div class="tooltip-content">Do you experience chest pain when you exercise?</div>
                        </div>
                        <select id="exang" name="exang" required>
                            <option value="0" selected>No</option>
                            <option value="1">Yes</option>
                        </select>
                        <span class="hint">Chest pain during physical activity?</span>
                    </div>

                    <!-- ST Depression -->
                    <div class="form-group" style="animation-delay: 0.4s">
                        <div class="label-row">
                            <label for="oldpeak">ST Depression (ECG Result)</label>
                            <span class="material-icons help-icon">help_outline</span>
                            <div class="tooltip-content">A value from an ECG test indicating heart stress. Enter 0 if unknown or if your ECG was normal.</div>
                        </div>
                        <input type="number" id="oldpeak" name="oldpeak" min="0" max="7" step="0.1" value="0.0" required>
                        <span class="hint">ECG value (Enter 0 if unknown)</span>
                    </div>

                    <!-- Number of Major Vessels (ca) -->
                    <div class="form-group" style="animation-delay: 0.45s">
                        <div class="label-row">
                            <label for="ca">Major Vessels (Fluoroscopy)</label>
                            <span class="material-icons help-icon">help_outline</span>
                            <div class="tooltip-content">Number of major blood vessels colored by fluoroscopy during cardiac catheterization. This shows how many vessels have significant blockage. Select 0 if you haven't had this test.</div>
                        </div>
                        <select id="ca" name="ca" required>
                            <option value="0" selected>0 - None or Unknown</option>
                            <option value="1">1 vessel</option>
                            <option value="2">2 vessels</option>
                            <option value="3">3 vessels</option>
                        </select>
                        <span class="hint">From cardiac catheterization test</span>
                    </div>

                    <!-- Thalassemia (thal) -->
                    <div class="form-group" style="animation-delay: 0.5s">
                        <div class="label-row">
                            <label for="thal">Thalassemia (Stress Test)</label>
                            <span class="material-icons help-icon">help_outline</span>
                            <div class="tooltip-content">Result from a thallium stress test showing blood flow to the heart:
- Normal: Blood flows normally
- Fixed Defect: Permanent reduced blood flow (prior damage)
- Reversible Defect: Reduced flow during stress only (blockage)
Select Normal if you haven't had this test.</div>
                        </div>
                        <select id="thal" name="thal" required>
                            <option value="3" selected>Normal (or Unknown)</option>
                            <option value="6">Fixed Defect</option>
                            <option value="7">Reversible Defect</option>
                        </select>
                        <span class="hint">From thallium stress test</span>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" id="submit-btn" class="btn-primary">
                        <span class="btn-text">Assess Risk</span>
                        <span class="btn-loading" style="display: none;">
                            <span class="spinner"></span> Processing...
                        </span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Results Section -->
        <div id="results" class="results-section" style="display: none;">
            <div class="card result-card">
                <div id="risk-header" class="result-header">
                    <span class="material-icons" id="risk-icon"></span>
                    <h2 id="risk-title">Assessment Result</h2>
                    <div class="probability-badge" id="probability-badge"></div>
                </div>
                
                <div class="result-body">
                    <div class="risk-score">
                        <span id="risk-text" class="display-text"></span>
                    </div>
                    <p id="risk-message" class="result-message"></p>
                </div>

                <div class="divider"></div>

                <!-- Unified Clinical Analysis -->
                <div class="clinical-analysis">
                    <h3>Risk Factor Breakdown</h3>
                    <p class="importance-subtitle">How your specific health metrics influenced this result:</p>
                    
                    <div class="analysis-legend">
                        <div class="legend-item">
                            <span class="legend-dot protective"></span>
                            <span>Protective Factor (Lowers Risk)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot risk"></span>
                            <span>Risk Factor (Increases Risk)</span>
                        </div>
                    </div>

                    <div id="analysis-chart"></div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <div class="disclaimer-box">
                <span class="material-icons disclaimer-icon">info</span>
                <div class="disclaimer-text">
                    <strong>Educational Use Only:</strong> This tool uses a machine learning model for demonstration purposes. 
                    It is not a medical device and cannot diagnose heart disease. Consult a doctor for professional advice.
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Tooltip Logic
        document.querySelectorAll('.help-icon').forEach(icon => {
            icon.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent document click from closing immediately
                
                // Close other open tooltips first
                document.querySelectorAll('.tooltip-content.visible').forEach(t => {
                    if (t !== this.nextElementSibling) {
                        t.classList.remove('visible');
                        t.previousElementSibling.classList.remove('active');
                    }
                });

                const tooltip = this.nextElementSibling;
                this.classList.toggle('active');
                tooltip.classList.toggle('visible');
            });
        });

        // Close tooltips when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.classList.contains('help-icon')) {
                document.querySelectorAll('.tooltip-content.visible').forEach(t => {
                    t.classList.remove('visible');
                    t.previousElementSibling.classList.remove('active');
                });
            }
        });

        // Ripple Effect
        document.querySelectorAll('.btn-primary').forEach(btn => {
            btn.addEventListener('click', function(e) {
                const circle = document.createElement('span');
                const diameter = Math.max(this.clientWidth, this.clientHeight);
                const radius = diameter / 2;

                // Calculate click position relative to button
                const rect = this.getBoundingClientRect();
                
                circle.style.width = circle.style.height = `${diameter}px`;
                circle.style.left = `${e.clientX - rect.left - radius}px`;
                circle.style.top = `${e.clientY - rect.top - radius}px`;
                circle.classList.add('ripple');

                // Remove existing ripple if any (optional, for rapid clicks)
                const ripple = this.getElementsByClassName('ripple')[0];
                if (ripple) {
                    ripple.remove();
                }

                this.appendChild(circle);
            });
        });

        document.getElementById('risk-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submit-btn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');

            // Show loading state
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            submitBtn.disabled = true;

            // Collect form data
            const formData = {
                age: document.getElementById('age').value,
                sex: document.getElementById('sex').value,
                cp: document.getElementById('cp').value,
                trestbps: document.getElementById('trestbps').value,
                chol: document.getElementById('chol').value,
                thalach: document.getElementById('thalach').value,
                exang: document.getElementById('exang').value,
                oldpeak: document.getElementById('oldpeak').value,
                ca: document.getElementById('ca').value,
                thal: document.getElementById('thal').value
            };

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.error) {
                    alert(result.message);
                    return;
                }

                // Display results
                displayResults(result);

            } catch (error) {
                alert('Error: Could not connect to the server. Please ensure the Flask app is running.');
                console.error('Error:', error);
            } finally {
                // Reset button state
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        const FEATURE_ORDER = [
            'age',
            'age_adjusted_hr',
            'age_bp_risk',
            'age_chol_risk',
            'metabolic_risk',
            'st_severity',
            'exercise_stress_index',
            'vessel_severity',
            'high_bp',
            'high_chol',
            'asymptomatic_cp',
            'exang',
            'chol',
            'trestbps',
            'thalach'
        ];

        const typicalRanges = {
            age: '20-100 yrs',
            sex: '0=Female, 1=Male',
            cp: '1-4 (angina types)',
            trestbps: '90-140 mmHg',
            chol: '125-240 mg/dl',
            thalach: '120-190 bpm',
            exang: '0=No, 1=Yes',
            oldpeak: '0-2',
            ca: '0-3',
            thal: '3=Normal,6=Fixed,7=Reversible',
            age_adjusted_hr: '0.5-0.9 ratio',
            age_bp_risk: '5-20',
            age_chol_risk: '15-40',
            metabolic_risk: '2-6',
            st_severity: '0-10',
            exercise_stress_index: '0-15',
            vessel_severity: '0-10',
            high_bp: '0/1',
            high_chol: '0/1',
            asymptomatic_cp: '0/1'
        };

        const categoricalLabels = {
            sex: { '0': 'Female', '1': 'Male' },
            cp: { '1': 'Typical', '2': 'Atypical', '3': 'Non-anginal', '4': 'Asymptomatic' },
            exang: { '0': 'No', '1': 'Yes' },
            ca: { '0': '0', '1': '1', '2': '2', '3': '3' },
            thal: { '3': 'Normal', '6': 'Fixed Defect', '7': 'Reversible' }
        };

        function formatValue(key, value) {
            if (value === null || value === undefined || Number.isNaN(value)) return 'â€”';
            const strVal = String(value);
            const num = Number(value);

            // Handle categorical labels first
            if (categoricalLabels[key] && categoricalLabels[key][strVal] !== undefined) {
                return categoricalLabels[key][strVal];
            }

            // Special user-friendly formatting for specific features
            if (key === 'age_adjusted_hr' && !Number.isNaN(num)) {
                return Math.round(num * 100) + '% of max HR';
            }
            if (key === 'high_bp' || key === 'high_chol' || key === 'asymptomatic_cp' || key === 'low_hr_reserve') {
                return num >= 1 ? 'Yes' : 'No';
            }
            if (key === 'metabolic_risk' && !Number.isNaN(num)) {
                if (num < 2.5) return 'Low';
                if (num < 4) return 'Moderate';
                return 'Elevated';
            }
            if ((key === 'age_bp_risk' || key === 'age_chol_risk') && !Number.isNaN(num)) {
                if (num < 8) return 'Low';
                if (num < 15) return 'Moderate';
                return 'Elevated';
            }
            if (key === 'age' && !Number.isNaN(num)) {
                return Math.round(num) + ' years';
            }
            if (key === 'trestbps' && !Number.isNaN(num)) {
                return Math.round(num) + ' mmHg';
            }
            if (key === 'chol' && !Number.isNaN(num)) {
                return Math.round(num) + ' mg/dL';
            }
            if (key === 'thalach' && !Number.isNaN(num)) {
                return Math.round(num) + ' bpm';
            }

            // Default numeric formatting
            if (!Number.isNaN(num)) {
                if (Math.abs(num) >= 1000) return num.toFixed(0);
                if (Math.abs(num) >= 10) return num.toFixed(1);
                if (Math.abs(num) >= 1) return num.toFixed(1);
                return num.toFixed(2);
            }
            return strVal;
        }

        function buildFallbackFactors(result) {
            const inputs = result.inputs || {};
            const importance = result.feature_importance || {};
            const factors = [];

            FEATURE_ORDER.forEach(feature => {
                const imp = importance[feature] !== undefined ? importance[feature] : 0.1;
                const val = inputs[feature];
                factors.push({
                    feature,
                    label: (feature.replace(/_/g, ' ')).replace(/\b\w/g, l => l.toUpperCase()),
                    impact: Math.abs(imp),
                    direction: imp >= 0, // assume positive importance as risk
                    value: val
                });
            });

            if (!factors.length) return [];
            return factors.sort((a, b) => b.impact - a.impact).slice(0, 8);
        }

        function displayResults(result) {
            const resultsSection = document.getElementById('results');
            const riskHeader = document.getElementById('risk-header');
            const riskIcon = document.getElementById('risk-icon');
            const riskText = document.getElementById('risk-text');
            const riskMessage = document.getElementById('risk-message');
            const analysisChart = document.getElementById('analysis-chart');
            const legend = document.querySelector('.analysis-legend');
            const probabilityBadge = document.getElementById('probability-badge');

            // Reset classes
            riskHeader.className = 'result-header';

            // Set risk level styling
            if (result.prediction === 1) {
                riskHeader.classList.add('high-risk-bg');
                riskIcon.textContent = 'warning';
                riskText.textContent = 'Elevated Risk';
                riskText.style.color = '#ff3b30';
            } else {
                riskHeader.classList.add('low-risk-bg');
                riskIcon.textContent = 'check_circle';
                riskText.textContent = 'Lower Risk';
                riskText.style.color = '#34c759';
            }

            riskMessage.textContent = result.message;
            if (result.probability !== null && result.probability !== undefined) {
                const pct = result.prediction === 1 ? result.probability : (1 - result.probability);
                probabilityBadge.textContent = `${Math.round(pct * 100)}% confidence`;
                probabilityBadge.style.display = 'inline-flex';
            } else {
                probabilityBadge.style.display = 'none';
            }

            // Unified Clinical Analysis Logic using tornado_factors (guaranteed)
            analysisChart.innerHTML = '';
            const factors = (result.tornado_factors && result.tornado_factors.length)
                ? result.tornado_factors
                : buildFallbackFactors(result);
            const maxImpact = factors.length ? Math.max(...factors.map(f => f.impact || 0)) || 1 : 1;
            legend.style.display = 'flex';
            console.log('Risk factors', factors, 'maxImpact', maxImpact);

            if (!factors.length) {
                const empty = document.createElement('p');
                empty.className = 'importance-subtitle';
                empty.textContent = 'No factor breakdown available.';
                analysisChart.appendChild(empty);
            } else {
                // Add helpful instruction
                const instruction = document.createElement('p');
                instruction.className = 'click-instruction';
                instruction.innerHTML = '<span class="material-icons">touch_app</span> Click on any factor to see more details and recommendations';
                analysisChart.appendChild(instruction);

                factors.forEach((factor, index) => {
                    renderAnalysisRow(factor, maxImpact, index);
                });
            }

            // Helper to render rows with enhanced UX
            function renderAnalysisRow(factor, maxValue, index) {
                const {
                    label, impact, direction: isRisk, feature: featureKey, value: rawVal,
                    description, detail, category_icon, category_name, is_modifiable, recommendation
                } = factor;

                const row = document.createElement('div');
                row.className = 'analysis-row' + (is_modifiable ? ' modifiable' : '');
                row.style.animationDelay = `${index * 80}ms`;

                // Category icon
                const categoryIcon = document.createElement('span');
                categoryIcon.className = 'material-icons category-icon';
                categoryIcon.textContent = category_icon || 'info';
                categoryIcon.title = category_name || '';

                // Label with description
                const labelDiv = document.createElement('div');
                labelDiv.className = 'analysis-label';

                const labelText = document.createElement('span');
                labelText.className = 'label-text';
                labelText.textContent = label;

                const descText = document.createElement('span');
                descText.className = 'label-desc';
                descText.textContent = description || '';

                labelDiv.appendChild(labelText);
                if (description) {
                    labelDiv.appendChild(descText);
                }

                // Value chip - simplified to just show the formatted value
                const valueChip = document.createElement('div');
                valueChip.className = 'value-chip';
                valueChip.textContent = formatValue(featureKey, rawVal);

                // Bar track
                const track = document.createElement('div');
                track.className = 'analysis-track';

                const leftHalf = document.createElement('div');
                leftHalf.className = 'analysis-half left';
                const leftFill = document.createElement('div');
                leftFill.className = 'analysis-fill';
                leftHalf.appendChild(leftFill);

                const rightHalf = document.createElement('div');
                rightHalf.className = 'analysis-half right';
                const rightFill = document.createElement('div');
                rightFill.className = 'analysis-fill';
                rightHalf.appendChild(rightFill);

                track.appendChild(leftHalf);
                track.appendChild(rightHalf);

                const textClass = isRisk ? 'analysis-value risk-text' : 'analysis-value protective-text';
                const icon = isRisk ? 'trending_up' : 'trending_down';
                const text = isRisk ? 'Increases risk' : 'Protective';

                const percentage = maxValue ? (impact / maxValue) * 100 : 0;
                const safeWidth = Math.max(percentage, 5);

                // Use requestAnimationFrame for more reliable animations
                const delay = 80 + (index * 100);
                setTimeout(() => {
                    requestAnimationFrame(() => {
                        if (isRisk) {
                            leftFill.style.width = `${safeWidth}%`;
                        } else {
                            rightFill.style.width = `${safeWidth}%`;
                        }
                    });
                }, delay);

                const valueDiv = document.createElement('div');
                valueDiv.className = textClass;
                valueDiv.innerHTML = `<span class="material-icons">${icon}</span> ${text}`;

                const trackLabels = document.createElement('div');
                trackLabels.className = 'analysis-track-labels';
                trackLabels.innerHTML = '<span>Increased Risk</span><span>Neutral</span><span>Protective</span>';

                const barGroup = document.createElement('div');
                barGroup.className = 'analysis-bar-group';
                barGroup.appendChild(track);
                barGroup.appendChild(trackLabels);

                // Build the main content row
                const mainContent = document.createElement('div');
                mainContent.className = 'analysis-main';
                mainContent.appendChild(categoryIcon);
                mainContent.appendChild(labelDiv);
                mainContent.appendChild(barGroup);
                mainContent.appendChild(valueDiv);
                mainContent.appendChild(valueChip);

                row.appendChild(mainContent);

                // Expandable details section
                if (detail || recommendation) {
                    const detailsSection = document.createElement('div');
                    detailsSection.className = 'analysis-details';

                    if (detail) {
                        const detailP = document.createElement('p');
                        detailP.className = 'detail-text';
                        detailP.innerHTML = `<span class="material-icons">info</span> ${detail}`;
                        detailsSection.appendChild(detailP);
                    }

                    if (recommendation && is_modifiable) {
                        const recDiv = document.createElement('div');
                        recDiv.className = 'recommendation-box';
                        recDiv.innerHTML = `<span class="material-icons">lightbulb</span><div><strong>What you can do:</strong> ${recommendation}</div>`;
                        detailsSection.appendChild(recDiv);
                    }

                    row.appendChild(detailsSection);

                    // Toggle details on click
                    mainContent.style.cursor = 'pointer';
                    mainContent.addEventListener('click', () => {
                        row.classList.toggle('expanded');
                    });

                    // Add expand indicator
                    const expandIcon = document.createElement('span');
                    expandIcon.className = 'material-icons expand-icon';
                    expandIcon.textContent = 'expand_more';
                    mainContent.appendChild(expandIcon);
                }

                analysisChart.appendChild(row);
            }

            // Show results section
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
</body>
</html>
